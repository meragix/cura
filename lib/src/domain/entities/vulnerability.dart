/// A security vulnerability reported by OSV.dev for a Dart / Flutter package.
///
/// Instances are constructed either from the live OSV.dev API response (via
/// the infrastructure layer) or deserialized from the SQLite cache via
/// [fromJson]. All fields that are optional in the OSV schema are nullable.
class Vulnerability {
  /// OSV identifier (e.g. `GHSA-xxxx-xxxx-xxxx` or `CVE-YYYY-NNNNN`).
  final String id;

  /// Short human-readable description of the vulnerability.
  final String summary;

  /// Extended description including technical context and impact.
  final String details;

  /// Severity classification aligned with the OSV.dev schema.
  final VulnerabilitySeverity severity;

  /// The date this vulnerability was first published.
  final DateTime published;

  /// The date this entry was last modified, or `null` when not provided.
  final DateTime? modified;

  /// Package version ranges confirmed to be affected.
  final List<String> affectedVersions;

  /// The first version in which the vulnerability is resolved, or `null`
  /// when no fix has been released yet.
  final String? fixedVersion;

  /// Advisory and reference URLs (NVD, GitHub Security Advisories, etc.).
  final List<String> references;

  /// Creates a [Vulnerability] with the provided fields.
  const Vulnerability({
    required this.id,
    required this.summary,
    required this.details,
    required this.severity,
    required this.published,
    this.modified,
    required this.affectedVersions,
    this.fixedVersion,
    required this.references,
  });

  /// Serialises this vulnerability to a JSON-compatible map.
  ///
  /// Severity is stored as its lowercase enum name so that [fromJson] can
  /// round-trip it through [VulnerabilitySeverity.fromString].
  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'summary': summary,
      'details': details,
      'severity': severity.name,
      'affected_versions': affectedVersions,
      'fixed_version': fixedVersion,
      'published': published.toIso8601String(),
      'references': references,
    };
  }

  /// Deserialises a [Vulnerability] from a JSON map produced by [toJson].
  ///
  /// When `published` is absent the current date is used as a safe fallback
  /// to avoid null-assertion errors in the presentation layer.
  factory Vulnerability.fromJson(Map<String, dynamic> json) {
    return Vulnerability(
      id: json['id'] as String,
      summary: json['summary'] as String,
      details: json['details'] as String,
      severity: VulnerabilitySeverity.fromString(json['severity'] as String),
      affectedVersions:
          (json['affected_versions'] as List).map((e) => e.toString()).toList(),
      fixedVersion: json['fixed_version'] as String?,
      published: json['published'] != null
          ? DateTime.parse(json['published'] as String)
          : DateTime.now(),
      references:
          (json['references'] as List).map((e) => e.toString()).toList(),
    );
  }

  /// Whether a patched version is available.
  bool get hasFixAvailable => fixedVersion != null;

  /// Whether this vulnerability is classified as [VulnerabilitySeverity.critical].
  bool get isCritical => severity == VulnerabilitySeverity.critical;

  /// Whether this vulnerability is classified as [VulnerabilitySeverity.high].
  bool get isHigh => severity == VulnerabilitySeverity.high;

  /// Number of days elapsed since [published].
  int get daysSincePublished => DateTime.now().difference(published).inDays;

  @override
  String toString() => 'Vulnerability($id, severity: $severity)';
}

/// Severity levels aligned with the OSV.dev CVSS classification scheme.
///
/// Values are ordered from most to least severe. Use [fromString] to parse
/// the lowercase name returned by the OSV API or stored in the cache.
enum VulnerabilitySeverity {
  /// CVSS base score ≥ 9.0. Automatic score of 0 for the affected package.
  critical,

  /// CVSS base score 7.0–8.9.
  high,

  /// CVSS base score 4.0–6.9.
  medium,

  /// CVSS base score 0.1–3.9.
  low,

  /// Severity could not be determined from the OSV entry.
  unknown;

  /// Parses a severity string (case-insensitive) into a [VulnerabilitySeverity].
  ///
  /// Returns [unknown] for any unrecognised value rather than throwing.
  static VulnerabilitySeverity fromString(String value) {
    return switch (value.toLowerCase()) {
      'critical' => critical,
      'high' => high,
      'medium' => medium,
      'low' => low,
      _ => unknown,
    };
  }
}
